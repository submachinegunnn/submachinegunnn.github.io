<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Stealth Pro | Secure AI</title>
    <style>
        :root { --accent: #A020F0; --bg: #0B0B0B; --card: #121212; --text: #D1D1D1; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
        
        header { background: var(--card); padding: 15px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: var(--accent); font-weight: bold; letter-spacing: 1px; }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 15px; line-height: 1.5; font-size: 15px; animation: fadeIn 0.3s ease; }
        .user { align-self: flex-end; background: var(--accent); color: white; }
        .ai { align-self: flex-start; background: var(--card); border: 1px solid #333; }
        
        .input-area { background: var(--card); padding: 15px; border-top: 1px solid #222; display: flex; gap: 10px; align-items: center; }
        textarea { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 10px; resize: none; outline: none; }
        
        .btn { background: var(--accent); color: white; border: none; padding: 12px 15px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-draw { background: #333; font-size: 1.2rem; }
        .btn:active { transform: scale(0.95); opacity: 0.8; }

        img.gen-image { width: 100%; border-radius: 10px; margin-top: 10px; border: 1px solid #444; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="logo">STEALTH <span style="font-size: 10px; opacity: 0.6;">V7.0</span></div>
</header>

<div id="chat-window"></div>

<div class="input-area">
    <button class="btn btn-draw" onclick="generateImage()" title="Generate Image">ðŸŽ¨</button>
    <textarea id="user-input" rows="1" placeholder="Ask anything..."></textarea>
    <button class="btn" onclick="handleSend()">SEND</button>
</div>

<script>
    let chatHistory = [];

    // FIXED: Reader for Vercel AI SDK 0:"text" protocol
    async function handleSend() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;

        appendMsg('user', text);
        input.value = '';
        const aiBubble = appendEmptyMsg('ai');

        try {
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ messages: [{ role: "user", content: text }] })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('0:')) {
                        // Extract content between quotes and handle escaped characters
                        let content = line.slice(2).trim();
                        if (content.startsWith('"') && content.endsWith('"')) {
                            content = content.slice(1, -1);
                        }
                        fullText += content.replace(/\\n/g, '\n').replace(/\\"/g, '"');
                    }
                }
                aiBubble.innerText = fullText || "...";
                document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
            }
        } catch (e) {
            aiBubble.innerText = "Error: System Offline.";
        }
    }

    // NEW: Free Image Generation Logic
    function generateImage() {
        const input = document.getElementById('user-input');
        const prompt = input.value.trim();
        if (!prompt) {
            alert("Type what you want to draw in the text box first!");
            return;
        }

        appendMsg('user', `Draw: ${prompt}`);
        const aiBubble = appendEmptyMsg('ai');
        aiBubble.innerHTML = `<i>Generating vision...</i><br>`;
        
        // Using Pollinations.ai (Free API)
        const seed = Math.floor(Math.random() * 10000);
        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${seed}&width=1024&height=1024&nologo=true`;
        
        const img = document.createElement('img');
        img.src = imageUrl;
        img.className = 'gen-image';
        img.onload = () => {
            aiBubble.innerHTML = `<b>Result:</b><br>`;
            aiBubble.appendChild(img);
        };
        input.value = '';
    }

    function appendMsg(sender, text) {
        const win = document.getElementById('chat-window');
        const d = document.createElement('div');
        d.className = `message ${sender}`;
        d.innerText = text;
        win.appendChild(d);
        win.scrollTop = win.scrollHeight;
    }

    function appendEmptyMsg(sender) {
        const win = document.getElementById('chat-window');
        const d = document.createElement('div');
        d.className = `message ${sender}`;
        win.appendChild(d);
        return d;
    }
</script>
</body>
</html>
